import { useState, useEffect, useRef } from 'react';
import '../output.css';

const ConflictBoard = () => {
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [messages, setMessages] = useState([]);
  const textareaRef = useRef(null);
  const [userMessage, setUserMessage] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const [userResponses, setUserResponses] = useState([]);
  const [finalMessage, setFinalMessage] = useState('');
  const [showSavePopup, setShowSavePopup] = useState(false);
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [selectedMood, setSelectedMood] = useState(null);
  const [showMoodOptions, setShowMoodOptions] = useState(false);
  const [allResponses, setAllResponses] = useState([
    {
      finalMessage: "Í¥úÏ∞ÆÏïÑ, ÎÑ§Í∞Ä Ìïú ÎÖ∏Î†•ÏùÄ Ï∂©Î∂ÑÌûà Í∞ÄÏπò ÏûàÏñ¥",
      userResponses: [
        "ÎÑ§Í∞Ä Ìï¥ÎÇ∏ Í±¥ Î≥ÑÍ±∞ ÏïÑÎãàÏïº, Îã§Îì§ ÏâΩÍ≤å Ìï† Ïàò ÏûàÎäî Í±∞Ïïº.",
        "Í∑∏ ÎßêÏù¥ ÏÜçÏÉÅÌñàÎçò Ïù¥Ïú†: ÏïÑÎ¨¥Î¶¨ ÎÖ∏Î†•Ìï¥ÎèÑ Î∂ÄÏ°±Ìïú ÎäêÎÇåÏù¥ Îì§Ïñ¥Ïöî.",
        "ÏÉÅÎåÄÎ∞©Ïùò ÏùòÎèÑ: ÏïÑÎßà Ï†ÄÎ•º ÏûêÍ∑πÌïòÎ†§Í≥† Ìïú ÎßêÏùºÏßÄÎèÑ Î™∞ÎùºÏöî."
      ],
      timestamp: "5Î∂Ñ Ï†Ñ",
      moodIcon: "üòä",
      isExpanded: false,
    },
    {
      finalMessage: "ÎÑå Ï∂©Î∂ÑÌûà ÏûòÌïòÍ≥† ÏûàÏñ¥, ÏûêÏã†Í∞êÏùÑ Í∞ÄÏ†∏!",
      userResponses: [
        "Ïôú Í∑∏Î†áÍ≤å Í≤åÏúºÎ•∏ Í±∞Ïïº?",
        "Í∑∏ ÎßêÏù¥ ÏÜçÏÉÅÌñàÎçò Ïù¥Ïú†: Ïä§Ïä§Î°úÍ∞Ä Í≤åÏúºÎ•¥Îã§Îäî ÏÉùÍ∞ÅÏù¥ Îì§Ïñ¥Ïöî.",
        "ÏÉÅÎåÄÎ∞©Ïùò ÏùòÎèÑ: Ï†úÍ∞Ä Îçî Î∞úÏ†ÑÌïòÍ∏∏ Î∞îÎùºÏÑú Ìïú ÎßêÏùº ÏàòÎèÑ ÏûàÏñ¥Ïöî."
      ],
      timestamp: "1Ïùº Ï†Ñ",
      moodIcon: "üåà",
      isExpanded: false,
    },
  ]);

  const moodIcons = ["üòä", "üòå", "üôÇ", "üåà", "üåü", "üëç", "üí™", "‚ù§Ô∏è"];

  const initialMessages = [
    { sender: 'Ïõ®Ïù¥', text: `ÏïàÎÖïÌïòÏÑ∏Ïöî, Ï†ÄÎäî Ïõ®Ïù¥ÏûÖÎãàÎã§. üê±\n\nÏò§Îäò ÏÜçÏÉÅÌïú ÏùºÏù¥ ÏûàÏúºÏÖ®ÎÇòÏöî?\n\nÏ†ÄÏôÄ Ìï®Íªò Ï≤úÏ≤úÌûà Ïù¥ÏïºÍ∏∞ ÎÇòÎàÑÎ©∞\nÎßàÏùåÏùÑ Ï†ïÎ¶¨Ìï¥Î≥¥Îäî Í±¥ Ïñ¥ÎïåÏöî? üí≠` },
    { sender: 'Ïõ®Ïù¥', text: `üïäÔ∏è\n\nÏßàÎ¨∏ÏùÄ Ï¥ù 3Í∞úÎ°ú Íµ¨ÏÑ±ÎêòÏñ¥ ÏûàÍ≥†,\nÎßàÏßÄÎßâ ÎãµÎ≥Ä ÌõÑ Ï†ÑÏ≤¥ ÎÇ¥Ïö©ÏùÑ ÏöîÏïΩÌï¥ ÎìúÎ¶¥Í≤åÏöî. üìù` },
    { sender: 'Ïõ®Ïù¥', text: `Ï†ïÎ¶¨Îêú ÎÇ¥Ïö©ÏùÑ Î≥¥ÏãúÍ≥†,\nÏä§Ïä§Î°úÏóêÍ≤å ÏúÑÎ°úÏùò ÎßêÏùÑ\nÍ±¥ÎÑ§Î≥¥Îäî ÏãúÍ∞ÑÏùÑ Í∞ÄÏ†∏Î≥¥ÏÑ∏Ïöî. üí¨` },
    { isSeparator: true },
    { sender: 'Ïõ®Ïù¥', text: `Ï≤´ Î≤àÏß∏ ÏßàÎ¨∏ÏûÖÎãàÎã§. üå±\n\nÏò§Îäò Í∞ÄÏû• ÏÜçÏÉÅÌñàÎçò ÎßêÏùÄ\nÎ¨¥ÏóáÏù∏Í∞ÄÏöî? ü§î` }
  ];

  const questions = [
    "Îëê Î≤àÏß∏ ÏßàÎ¨∏ÏûÖÎãàÎã§.\n\nÍ∑∏ ÎßêÏù¥ Ïôú ÏÜçÏÉÅÌñàÎäîÏßÄ\nÎßêÏîÄÌï¥ Ï£ºÏã§ÎûòÏöî? ü•∫",
    "ÎßàÏßÄÎßâ ÏßàÎ¨∏ÏûÖÎãàÎã§.\n\nÏÉÅÎåÄÍ∞Ä Í∑∏Îü∞ ÎßêÏùÑ Ìïú\nÏù¥Ïú†Í∞Ä Î¨¥ÏóáÏùºÍπåÏöî?",
  ];

  useEffect(() => {
    if (isChatOpen) {
      setMessages([]);
      setUserResponses([]);
      setCurrentQuestionIndex(0);
      setFinalMessage('');
      setShowMoodOptions(false);

      initialMessages.forEach((message, index) => {
        setTimeout(() => {
          setMessages((prev) => [...prev, message]);
        }, index * 3000);
      });
    }
  }, [isChatOpen]);

  useEffect(() => {
    if (currentQuestionIndex === questions.length + 1) {
      const summaryMessage = {
        sender: 'Ïõ®Ïù¥',
        text: `Ï†úÍ∞Ä Ï†ïÎ¶¨Ìïú ÎÇ¥Ïö©ÏùÑ ÎßêÏîÄÎìúÎ¶¥Í≤åÏöî. üí°\n\n` +
              `‚ñ™Ô∏è ÏÜçÏÉÅÌïòÍ≤å Ìïú Îßê: "${userResponses[0] || ''}\n"` +
              `‚ñ™Ô∏è ÏÉÅÏ≤òÍ∞Ä Îêú Ïù¥Ïú†: ${userResponses[1] || ''}\n` +
              `‚ñ™Ô∏è ÏÉÅÎåÄÎ∞©Ïùò ÏùòÎèÑ: ${userResponses[2] || ''}\n\n` +
              "Ïù¥ ÎÇ¥Ïö©ÏùÑ Î∞îÌÉïÏúºÎ°ú, ÏûêÏã†ÏóêÍ≤å ÏúÑÎ°úÏùò ÎßêÏùÑ Í±¥ÎÑ§Î≥¥ÏÑ∏Ïöî. üí¨",
      };
      setMessages((prev) => [...prev, summaryMessage]);
    }
  }, [currentQuestionIndex, userResponses]);

  const handleSendMessage = () => {
    if (userMessage.trim()) {
      setMessages((prev) => [...prev, { sender: 'ÏÇ¨Ïö©Ïûê', text: userMessage }]);
      setUserResponses((prev) => [...prev, userMessage]); 
      setUserMessage('');
      resetTextareaHeight();
      setIsTyping(true);

      setTimeout(() => {
        const nextMessage = getNextBotMessage();
        if (nextMessage) {
          setMessages((prev) => [...prev, nextMessage]);
        }
        setIsTyping(false);
      }, 3500);
    }
  };

  const getNextBotMessage = () => {
    if (currentQuestionIndex < questions.length) {
      const question = questions[currentQuestionIndex];
      setCurrentQuestionIndex(currentQuestionIndex + 1);
      return { sender: 'Ïõ®Ïù¥', text: question };
    } else if (currentQuestionIndex === questions.length) {
      setCurrentQuestionIndex(currentQuestionIndex + 1);
      return null;
    }
    return null;
  };

  const handleFinalMessage = () => {
    setFinalMessage(userMessage);
    setMessages((prev) => [...prev, { sender: 'ÏÇ¨Ïö©Ïûê', text: userMessage }]);
    setUserMessage('');
    setIsTyping(true);

    setTimeout(() => {
      setMessages((prev) => [
        ...prev, 
        { sender: 'Ïõ®Ïù¥',  text: `Î©ãÏßÑ ÎãµÎ≥ÄÏù¥ÏóêÏöî. ÏûêÏã†ÏùÑ Îã§ÎèÖÏù¥Îäî ÎßêÏù¥ ÌÅ∞ ÌûòÏù¥ Îê† Í±∞ÏòàÏöî. üòä\n\n` +
          "Ïù¥Ï†ú Í∞êÏ†ïÏùÑ ÌëúÌòÑÌï† Ïàò ÏûàÎäî Ïù¥Î™®Ìã∞ÏΩòÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.\nÏù¥ Í∏∞Î°ùÏùÑ Ï†ÄÏû•Ìï†Í≤åÏöî, ÎÇòÏ§ëÏóê ÎèåÏïÑÎ≥¥Î©∞ Ïä§Ïä§Î°úÎ•º Îã§ÎèÖÏù¥Îäî Îç∞ ÎèÑÏõÄÏù¥ Îê† Í±∞ÏòàÏöî." }
      ]);
      setIsTyping(false);
      setShowMoodOptions(true);
    }, 2000);
  };

  const selectMood = (moodIcon) => {
    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    setAllResponses((prev) => [
      {
        finalMessage: finalMessage,
        userResponses: [...userResponses],
        timestamp: timestamp,
        moodIcon: moodIcon,
        isExpanded: false,
      },
      ...prev,
    ]);
    setSelectedMood(moodIcon);
    setShowSavePopup(true);
    setShowMoodOptions(false);
  };

  const handleReturnToMain = () => {
    setShowSavePopup(false);
    setIsChatOpen(false);
    setFinalMessage('');
  };

  const resetTextareaHeight = () => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto';
    }
  };

  const toggleExpandCard = (index) => {
    setAllResponses((prev) =>
      prev.map((response, idx) =>
        idx === index ? { ...response, isExpanded: !response.isExpanded } : response
      )
    );
  };

  const WayMessage = ({ text }) => (
    <div className="flex items-start">
      <div className="w-12 h-12 rounded-full bg-[#FEC673] flex items-center justify-center shadow-md font-['Pretendard_Variable']">
        <img
          className="w-10 h-10 rounded-full"
          src="/img/pink_catCrop.png"
          alt="Ïõ®Ïù¥"
        />
      </div>
      <div
        className="p-4 rounded-lg bg-gray-200 shadow-md ml-2"
        style={{
          display: 'inline-block',
          maxWidth: '75%',
          whiteSpace: 'pre-wrap',
          hyphens: 'auto',
          overflowWrap: 'break-word',
        }}
      >
        <p className="text-sm">{text}</p>
      </div>
    </div>
  );

  const UserMessage = ({ text }) => (
    <div className="flex justify-end">
      <div
        className="p-4 rounded-lg bg-blue-500 text-white shadow-md ml-2"
        style={{
          display: 'inline-block',
          maxWidth: '75%',
          wordBreak: 'break-word',
          whiteSpace: 'pre-wrap',
          hyphens: 'auto',
        }}
      >
        <p className="text-sm">{text}</p>
      </div>
    </div>
  );

  const renderChat = () => (
    <div className="relative w-full h-[800px] flex flex-col justify-start items-center bg-white  font-['Pretendard_Variable'] pt-0">
      <div className="sticky top-10 z-10 p-4 bg-[#f7f2fa] flex items-center justify-center shadow-sm border-b fixed px-6">
        <span className="text-[20px] font-bold text-[#4B4B4B]">Ïõ®Ïù¥Ïùò Î∂ÑÎÖ∏ ÏÉÅÎã¥ÏÜå</span>
      </div>

      <div className="flex-1 overflow-y-auto p-6 space-y-4 pt-5 bg-gray-50">
        {messages.map((msg, idx) =>
          msg.isSeparator ? (
            <div key={idx} className="flex items-center justify-center my-4">
              <div className="border-t border-gray-300 w-full mx-4"></div>
            </div>
          ) : msg.sender === 'Ïõ®Ïù¥' ? (
            <WayMessage key={idx} text={msg.text} />
          ) : (
            <UserMessage key={idx} text={msg.text} />
          )
        )}

        {isTyping && (
          <div className="typing-indicator flex items-center justify-start bg-gray-200 px-3 py-2 rounded-lg max-w-[75%] shadow-md ml-2">
            <div className="dot bg-gray-500 rounded-full w-2 h-2 mx-1 animate-bounce"></div>
            <div className="dot bg-gray-500 rounded-full w-2 h-2 mx-1 animate-bounce delay-75"></div>
            <div className="dot bg-gray-500 rounded-full w-2 h-2 mx-1 animate-bounce delay-150"></div>
          </div>
        )}

        {showMoodOptions && (
          <div className="flex space-x-2 mt-4">
            {moodIcons.map((icon, index) => (
              <span
                key={index}
                onClick={() => selectMood(icon)}
                className={`cursor-pointer text-2xl ${selectedMood === icon ? 'text-blue-500 border-2 border-blue-500 rounded-full p-1' : 'text-gray-500'}`}
              >
                {icon}
              </span>
            ))}
          </div>
        )}
      </div>

      <div className="flex items-center px-4 py-3 bg-white border-t border-gray-200">
        <textarea
          ref={textareaRef}
          rows={1}
          onInput={(e) => {
            e.target.style.height = 'auto';
            e.target.style.height = `${e.target.scrollHeight}px`;
          }}
          className="flex-1 p-3 bg-gray-100 border rounded-lg resize-none overflow-hidden"
          placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî"
          value={userMessage}
          onChange={(e) => setUserMessage(e.target.value)}
          style={{ maxHeight: '80px' }}
        />

        <button
          onClick={currentQuestionIndex === 3 ? handleFinalMessage : handleSendMessage}
          className="ml-2 px-4 py-2 bg-[#FFAD7A] text-white font-semibold rounded-[11px] hover:bg-[#E5946D] transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#FFAD7A]"
        >
          Î≥¥ÎÇ¥Í∏∞
        </button>
      </div>

      {showSavePopup && (
        <div className="fixed inset-0 flex justify-center items-center bg-black bg-opacity-50 z-50">
          <div className="bg-white p-6 rounded-lg shadow-lg text-center">
            <p>Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.<br/>Î©îÏù∏ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ëÎãàÎã§.</p>
            <button onClick={handleReturnToMain} className="mt-4 bg-blue-500 text-white py-2 px-4 rounded-lg">Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
          </div>
        </div>
      )}
    </div>
  );

  const renderTimeline = () => (
    
    <div className="relative w-full h-[800px] flex flex-col justify-start items-center bg-[#F9F8F6]  font-['Pretendard_Variable'] pt-0">
      <div className="sticky top-0 z-10 p-4 bg-white shadow-md">
        <h1 className="text-center text-[20px] font-bold text-[#4B4B4B]">Ïõ®Ïù¥Ïùò ÏÉÅÎã¥ Í∏∞Î°ù</h1>
      </div>
  
      <div className="space-y-6 p-4 mt-10 overflow-y-scroll">
        {allResponses.map((response, index) => (
          <div
            key={index}
            onClick={() => toggleExpandCard(index)}
            className="flex flex-col items-start bg-white p-5 rounded-lg shadow-md border border-gray-200 relative space-y-2 cursor-pointer"
          >
            {index !== allResponses.length - 1 && (
              <div className="absolute left-4 top-full h-6 w-1 bg-gray-300"></div>
            )}
            <div className="flex items-center text-sm text-gray-500 mb-1">
              <span className="mr-2 p-1 rounded-full bg-[#FFAD7A]/20 text-[#D88C65] text-lg">{response.moodIcon}</span>
              <span className="text-gray-400">{response.timestamp}</span>
            </div>
            <h2 className="text-[15px] font-semibold text-[#4B4B4B] leading-relaxed mb-2">
              {response.finalMessage}
            </h2>
            {response.isExpanded && (
              <div className="space-y-2 mt-2">
                <p className="text-[12px] text-gray-500">{response.userResponses[0]}</p>
                <p className="text-[12px] text-gray-500">{response.userResponses[1]}</p>
                <p className="text-[12px] text-gray-500">{response.userResponses[2]}</p>
              </div>
            )}
          </div>
        ))}
      </div>
  
      <button
        onClick={() => setIsChatOpen(true)}
        className="fixed bottom-[20px] right-[20px] bg-[#FFAD7A] text-white p-4 rounded-full shadow-lg hover:bg-[#E5946D] transition duration-200"
      >
        <img src="/img/pen_icon.png" alt="Ìéú" className="w-[48px] h-[50px] rounded-lg" />
      </button>
    </div>
  );

  return isChatOpen ? renderChat() : renderTimeline();
};

export default ConflictBoard;
